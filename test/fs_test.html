<script src="/js/test.js"></script>
<script src="/js/fs_helper.js"></script>
<script src="/js/fs.js"></script>
<script src="/js/lfs.js"></script>
<script>

async function test_layered_fns() {
    var lfs = new LayeredFilesystem();
    var tmp = new MyFS();
    await lfs.mkdir("/tmp", 0o777);
    await lfs.mount("/tmp", tmp);

    await lfs.create("/asdf", 0o777);
    assert((await lfs.readdir("/")).length == 2);
    console.log(await lfs.readdir("/tmp"));
    assert((await lfs.readdir("/tmp")).length == 0);

    await lfs.create("/tmp/asdf", 0o777);
    assert((await lfs.readdir("/tmp")).length == 1);
	console.log((await tmp.readdir("/")));
    assert((await tmp.readdir("/")).length == 1);
	return lfs;
}

async function test_readdir() {
    var fs = new MyFS();
    assert((await fs.readdir("/")).length == 0);
    await fs.open("/asdf", O_CREAT, 0o777);
    assert((await fs.readdir("/")).length == 1);
    return fs;
}

async function test_write(){
    fs = new MyFS();
    console.log((await fs.readdir("/")).length == 0);
    await fs.open("/asdf", O_CREAT, 0o777);
    file = await fs.open("/asdf", O_WRONLY);
    console.log(file);
    buffer = new ArrayBuffer(32);
    data = new Uint8Array(buffer);
    data.fill(65);
    await fs.write(file, data);
    await fs.close(file);

    console.log(await fs.readdir("/"));

    file = await fs.open("/asdf", O_RDONLY);
    console.log(file);

    buffer = new ArrayBuffer(32);
    data = new Uint8Array(buffer);
    await fs.read(file, data);
    console.log(data);

    await fs.close(file);
    return fs;
}

async function test_write_max(){
    fs = new MyFS();
    console.log(await fs.readdir("/").length == 0);
    await fs.open("/asdf", O_CREAT, 0o777);
    file = await fs.open("/asdf", O_WRONLY);
    console.log(file);
    buffer = new ArrayBuffer(fs.max_filesize);
    data = new Uint8Array(buffer);
    data.fill(65);
    await fs.write(file, data);
    await fs.close(file);

    console.log(await fs.readdir("/"));

    file = await fs.open("/asdf", O_RDONLY);
    console.log(file);

    buffer = new ArrayBuffer(fs.max_filesize);
    data = new Uint8Array(buffer);
    await fs.read(file, data);
    console.log(data);

    await fs.close(file);
    return fs;
}

async function test_mkdir() {
    fs = new MyFS();
    await fs.mkdir("/newdir", 0o777);
    await fs.open("/newdir/newfile", O_CREAT, 0o777);
    console.log(await fs.readdir("/"));
    console.log(await fs.readdir("/newdir"));
    return fs;
}

async function test_link() {
    fs = new MyFS();
    var file1 = await fs.open("/newfile", O_CREAT, 0o777);
    var inode2 = await fs.link("/newfile", "/newfile1");
    assert((await fs.readdir("/")).length == 2);
    assert(file1.inode == fs.inodes[inode2]);
    assert(typeof(i1) !== 'string');
    return fs;
}

async function test_unlink() {
    // Depends on test_link
    fs = await test_link();
    await fs.unlink("/newfile");
    dirs = await fs.readdir("/");
    assert(dirs.length == 1);
    assert(dirs[0].filename == "newfile1");
    await fs.unlink("/newfile1");
    dirs = await fs.readdir("/");
    assert(dirs.length == 0);
    return fs;
}
</script>
