<script src="fs.js"></script>
<script>

window.onload = main;

function assert(cond) {
    if (!cond)
        throw Error("Assertion failed!");
}

function run_test(test) {
    var return_val = null;
    try {
        return_val = test();
    } catch (err) {}
    if (return_val)
        document.body.appendChild(
            document.createTextNode(test.name + ": Success!"));
    else
        document.body.appendChild(
            document.createTextNode(test.name + ": Failed"));

    document.body.appendChild(document.createElement("br"));
}

function gen_run_test(name) {
    return () => { run_test(window[name]); };
}

function main() {
    var testnames =
        Object.getOwnPropertyNames(window).filter(
            (x) => x.startsWith("test_"));
    for (t in testnames) {
        test_runner = document.createElement("button");
    test_runner.onclick = gen_run_test(testnames[t]);
            test_runner.appendChild(document.createTextNode(testnames[t]));
        document.body.appendChild(test_runner);
    }
    document.body.appendChild(document.createElement("br"));
}

function test_readdir() {
    fs = new MyFS();
    assert(fs.readdir("/").length == 0);
    fs.open("/asdf", O_CREAT, 0o777);
    assert(fs.readdir("/").length == 1);
    return fs;
}

function test_write(){
    fs = new MyFS();
    console.log(fs.readdir("/").length == 0);
    fs.open("/asdf", O_CREAT, 0o777);
    file = fs.open("/asdf", O_WRONLY);
    console.log(file);
    buffer = new ArrayBuffer(32);
    data = new Uint8Array(buffer);
    data.fill(65);
    fs.write(file, data);
    fs.close(file);

    console.log(fs.readdir("/"));

    file = fs.open("/asdf", O_RDONLY);
    console.log(file);

    buffer = new ArrayBuffer(32);
    data = new Uint8Array(buffer);
    fs.read(file, data);
    console.log(data);

    fs.close(file);
    return fs;
}

function test_write_max(){
    fs = new MyFS();
    console.log(fs.readdir("/").length == 0);
    fs.open("/asdf", O_CREAT, 0o777);
    file = fs.open("/asdf", O_WRONLY);
    console.log(file);
    buffer = new ArrayBuffer(fs.max_filesize);
    data = new Uint8Array(buffer);
    data.fill(65);
    fs.write(file, data);
    fs.close(file);

    console.log(fs.readdir("/"));

    file = fs.open("/asdf", O_RDONLY);
    console.log(file);

    buffer = new ArrayBuffer(fs.max_filesize);
    data = new Uint8Array(buffer);
    fs.read(file, data);
    console.log(data);

    fs.close(file);
    return fs;
}

function test_mkdir() {
    fs = new MyFS();
    fs.mkdir("/newdir", 0o777);
    fs.open("/newdir/newfile", O_CREAT, 0o777);
    console.log(fs.readdir("/"));
    console.log(fs.readdir("/newdir"));
    return fs;
}

function test_link() {
    fs = new MyFS();
    var file1 = fs.open("/newfile", O_CREAT, 0o777);
    var inode2 = fs.link("/newfile", "/newfile1");
    assert(fs.readdir("/").length == 2);
    assert(file1.inode == fs.inodes[inode2]);
    assert(typeof(i1) !== 'string');
    return fs;
}</script>
