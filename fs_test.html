<script src="test.js"></script>
<script src="utils.js"></script>
<script src="fs.js"></script>
<script>

window.onload = main;

function assert(cond) {
    if (!cond)
        throw Error("Assertion failed!");
}

async function run_test(test) {
    var return_val = null;
    try {
        return_val = await test();
    } catch (err) {
        console.log(err);
    }

    if (return_val)
        document.body.appendChild(
            document.createTextNode(test.name + ": Success!"));
    else
        document.body.appendChild(
            document.createTextNode(test.name + ": Failed"));

    document.body.appendChild(document.createElement("br"));
}

function gen_run_test(name) {
    return () => { run_test(window[name]); };
}

function main() {
    var testnames =
        Object.getOwnPropertyNames(window).filter(
            (x) => x.startsWith("test_"));
    for (t in testnames) {
        test_runner = document.createElement("button");
    test_runner.onclick = gen_run_test(testnames[t]);
            test_runner.appendChild(document.createTextNode(testnames[t]));
        document.body.appendChild(test_runner);
    }
    document.body.appendChild(document.createElement("br"));
}

async function test_readdir() {
    fs = new MyFS();
    assert((await fs.readdir("/")).length == 0);
    await fs.open("/asdf", O_CREAT, 0o777);
    assert((await fs.readdir("/")).length == 1);
    return fs;
}

async function test_write(){
    fs = new MyFS();
    console.log((await fs.readdir("/")).length == 0);
    await fs.open("/asdf", O_CREAT, 0o777);
    file = await fs.open("/asdf", O_WRONLY);
    console.log(file);
    buffer = new ArrayBuffer(32);
    data = new Uint8Array(buffer);
    data.fill(65);
    await fs.write(file, data);
    await fs.close(file);

    console.log(await fs.readdir("/"));

    file = await fs.open("/asdf", O_RDONLY);
    console.log(file);

    buffer = new ArrayBuffer(32);
    data = new Uint8Array(buffer);
    await fs.read(file, data);
    console.log(data);

    await fs.close(file);
    return fs;
}

async function test_write_max(){
    fs = new MyFS();
    console.log(await fs.readdir("/").length == 0);
    await fs.open("/asdf", O_CREAT, 0o777);
    file = await fs.open("/asdf", O_WRONLY);
    console.log(file);
    buffer = new ArrayBuffer(fs.max_filesize);
    data = new Uint8Array(buffer);
    data.fill(65);
    await fs.write(file, data);
    await fs.close(file);

    console.log(await fs.readdir("/"));

    file = await fs.open("/asdf", O_RDONLY);
    console.log(file);

    buffer = new ArrayBuffer(fs.max_filesize);
    data = new Uint8Array(buffer);
    await fs.read(file, data);
    console.log(data);

    await fs.close(file);
    return fs;
}

async function test_mkdir() {
    fs = new MyFS();
    await fs.mkdir("/newdir", 0o777);
    await fs.open("/newdir/newfile", O_CREAT, 0o777);
    console.log(await fs.readdir("/"));
    console.log(await fs.readdir("/newdir"));
    return fs;
}

async function test_link() {
    fs = new MyFS();
    var file1 = await fs.open("/newfile", O_CREAT, 0o777);
    var inode2 = await fs.link("/newfile", "/newfile1");
    assert((await fs.readdir("/")).length == 2);
    assert(file1.inode == fs.inodes[inode2]);
    assert(typeof(i1) !== 'string');
    return fs;
}

async function test_unlink() {
    // Depends on test_link
    fs = await test_link();
    await fs.unlink("/newfile");
    dirs = await fs.readdir("/");
    assert(dirs.length == 1);
    assert(dirs[0].filename == "newfile1");
    await fs.unlink("/newfile1");
    dirs = await fs.readdir("/");
    assert(dirs.length == 0);
    return fs;
}
</script>
